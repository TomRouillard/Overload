<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="Content-Language" content="fr" />

        <link rel="stylesheet" href="loader.css" />
    <body>
    <!-- <audio autoplay loop id="musicplayer">
      <source src="C:\Riot Games\League of Legends\RADS\projects\lol_air_client\releases\0.0.1.158\deploy\assets\sounds\ambient\ChmpSlct_Tutorial.mp3" type="audio/mp3">
    </audio> -->
        <ul class="team" id="red">

        </ul>

       <ul class="team" id="blue">
        </ul>
<script src="../commons/js/jquery-2.1.1.min.js"></script>
<script src="../commons/js/champions.js"></script>
<script src="../commons/js/summonerspells.js"></script>
<script src="../commons/js/summonericons.js"></script>
<script type="text/javascript">

    /*window.onload = function() {
        var backgroundAudio=document.getElementById("musicplayer");
        backgroundAudio.volume=0.2;
    }*/
    var champs = [];
    // $('#teamRed .player').addClass('animated fadeInLeft');
    // $('#teamBlue .player').addClass('animated fadeInRight');
    function Team(color) {
        this.color = color;
        this.players = [];
    }
    Team.prototype.addPlayer = function(player) {
        this.players.push(player);
    }
    Team.prototype.guessRoles = function() {
        var that = this;
        var roles = [];
        var jungler = checkSmite();
        if ( jungler!= -1) {
            this.players[jungler].role == "jungler";
        }



        function checkSmite() {
            var result = -1;
            for (var i = that.players.length - 1; i >= 0; i--) {
                if (that.players[i].summoners[0] == "11" || that.players[i].summoners[1] == "11"){
                    result = result == -1 ? i : -1;
                }
            };
            return result
        }

        function hasDuplicates(arr) {
            var sorted_arr = arr.sort(); // You can define the comparing function here.
                                         // JS by default uses a crappy string compare.
            var results = [];
            for (var i = 0; i < arr.length - 1; i++) {
                if (sorted_arr[i + 1] == sorted_arr[i]) {
                    results.push(sorted_arr[i]);
                }
            }
            return results
        }
    }
    function Player(name, skin, team) {
        this.name  = '';
        this.skin  = typeof skin !== 'undefined' ? skin : '';
        this.team  =  typeof team !== 'undefined' ? team : 'teamRed';
        this.summoners = typeof summoners !== 'undefined' ? summoners : ['' , ''];
        this.disconnected = true; //this.name == 'déconnecté';
        this.percent = 0;
        this.champion = 'Not connected yet';
        this.createPlayerHTML();
    }
    var players = {red: [], blue: []};
    Player.prototype.guessChamp = function() {
        var skin = this.skin;
        var champion = 'déconnecté';
        $.each(champs, function(id, champ) {
            if (champ in skin){
                champion = champ;
                return false;
            }
        })
        this.champion = champion;
        return champion;
    }

    Player.prototype.guessRole = function() {
        this.role = 'mid';
        return 'mid';
    }

    Player.prototype.createPlayerHTML = function() {
        this.container = $('<div class="player"></div>');
        this.championHTML = $('<div class="champion"></div>');
        this.playerMask = $('<div class="playerMask"></div>');
        this.blinkMask = $('<div class="blinkMask"></div>');

        this.championHTML.appendTo(this.container);

        this.summonersHTML = $('<span class="summoners"></span>');

        this.championName = $('<div class="championName">' +this.champion +'</div>');
        this.footer = $('<div class="playerFooter"></div>');

        this.finished=false;
        var self = this;
        setTimeout(function() {
            self.championName.appendTo(self.footer);
            self.footer.appendTo(self.container);
            self.finished=true;
        }, 500)

        this.listElement = $('<li></li>');
        this.container.appendTo(this.listElement)
        this.listElement.appendTo($('#'+this.team));
    }

    Player.prototype.realPlayer = function(champ, skin, summoners, infos, iconId) {
        var self = this;

        this.champion = champ in champions ? champions[champ].name: "champion not found";
        this.championId = champ;
        this.summoners = typeof summoners !== 'undefined' ? summoners : ['' , ''];
        this.summonerD = $('<img src="../commons/images/summonerspells/' + (this.summoners[1] in spells ? spells[this.summoners[1]].name : "notfound") + '.png" class="summonerD '+ (this.summoners[1] in spells ? spells[this.summoners[1]].name : "notfound")  + '">');
        this.summonerF = $('<img src="../commons/images/summonerspells/' + (this.summoners[0] in spells ? spells[this.summoners[0]].name : "notfound") + '.png" class="summonerF '+ (this.summoners[0] in spells ? spells[this.summoners[0]].name : "notfound") + '">');
        this.summonerD.appendTo(this.summonersHTML);
        this.summonerF.appendTo(this.summonersHTML);
        this.skin = skin ? skin : 0;
        this.footer.remove();
        this.iconHTML = $('<span class="icon"></span>');
        this.iconHTML.css("background-position", "-"+ (iconId in summonerIcons ? summonerIcons[iconId].x : 0) + "px -" +  (iconId in summonerIcons ? summonerIcons[iconId].y : 0) + "px");
        this.championName = $('<div class="championName">' +this.champion +'</div>');
        this.percentHTML = $('<div class="percent">0%</div>');
        this.nameHTML = $('<div class="name">' + infos.name +'</div>');
        this.percent = 0;
        this.loadingbar = $('<div class="loadingbar"></div>');
        this.maskLoadingbar = $('<div class="maskLoadingbar"></div>');
        this.footer = $('<div class="playerFooter"></div>');
        this.hiddenInfo = $('<div class="playerInfo"></div>');
        this.division = $('<div class="division">'+
            '<div class="divisionText">'+ infos.division +'</div>'+
            '<img src="../commons/images/leagues/' + (infos.division ? infos.division : 'unranked') +'.png">'+
            '</div>');
        this.additionalInfos = $('<div class="additionalInfos">'+
            (infos.winrate ? '<label>winrate</label><div class="winrate">'+ infos.winrate +'%</div>' : '<label>Not ranked</label>')+
            (infos.games ?'<div class="games">over '+ infos.games +' games <br> played with ' + self.champion + '</div>':'')+ '</div>');
        self.champVideo = $('<video class="champVideo" poster="'+ getSynchronizedVariant("imageDirectory") +('key' in champions[champ] ? champions[champ].key : champions[champ].name.replace(" ", "").replace("'", "").replace(".", "")) +'_Splash_0.jpg" src="../commons/video/'+this.champion.replace(" ", "").replace(".", "").replace("'", "")+'.webm" loop autoplay></video>');
        self.champVideo.appendTo(self.championHTML);
        self.champVideo.animate({
            opacity: 1,
            left: "-=" + (champ in champions ? champions[champ].skinsOffset[this.skin] : 0)
        }, 3000);

        this.playerMask.appendTo(this.championHTML);
        this.blinkMask.appendTo(this.championHTML);
        self.name = infos.name;
        self.championName.appendTo(self.footer);
        self.nameHTML.appendTo(self.footer);
        self.iconHTML.appendTo(self.footer);
        self.summonersHTML.appendTo(self.footer);
        self.iconHTML.appendTo(self.footer);
        self.percentHTML.appendTo(self.footer);
        self.footer.appendTo(self.container);
        self.maskLoadingbar.appendTo(self.championHTML);
        self.division.appendTo(self.hiddenInfo);
        self.additionalInfos.appendTo(self.hiddenInfo);
        self.hiddenInfo.appendTo(self.championHTML);
        self.loadingbar.appendTo(self.maskLoadingbar);
        self.container.mousemove(function() {
            self.hiddenInfo.show();
            self.footer.hide();
        })
        self.container.mouseout(function() {
            self.hiddenInfo.hide();
            self.footer.show();
        })

    }
    Player.prototype.definePercent = function(value) {
        var self = this;

        if (this.percent < value) {
            (function repeatPercent() {
                setTimeout(function(){
                    self.percent +=2;
                    if (self.percent == 100) {
                        self.readyAnimation();
                    }
                    self.percentHTML.text(self.percent + '%');
                    self.maskLoadingbar.css({'-webkit-clip-path':  'polygon( 0% ' + (100 - self.percent) + '%, 100% ' + (100 - self.percent) + '%, 100% 100%, 0% 100%)'});
                    if (self.percent < value) {
                        repeatPercent();
                    }
                },40)
            })()
        }

    }
    var tryAjx = 0;
    var teams = {red: null, blue: null};
    function init(){
        // var server = "EUW1";
        // var idPlayer = "28858597";
        // var key = "fc637cf1-2f0c-4011-8221-73399a14ed7b";
        // $.ajax({
        //     type: "GET",
        //     dataType: "json",
        //     // https://euw.api.pvp.net/observer-mode/rest/consumer/getSpectatorGameInfo/EUW1/vivacious jon?api_key=fc637cf1-2f0c-4011-8221-73399a14ed7b
        //     //http://95.85.46.198/api/game/EUW1/20138005
        //     url: "http://95.85.46.198/api/game/EUW1/" + idPlayer + "",
        //     success: function (data) {
        //         test(data);
        //     },
        //     error: function() {
        //         console.log('error dl infos', tryAjx);
        //         if (tryAjx<5) {
        //             setTimeout(function() {
        //                 tryAjx++;
        //                 init();
        //             }, 1000)
        //         }
        //     }
        // })

        // test(respTest);
        teams['red'] = new Team("red");
        teams['blue'] = new Team("blue");
        function test(data) {
            var nbPlayers = data.participants.length;
            var index = 0;
            var offset = [500, 680, 680, 520, 520, 400, 400, 260, 260, 120, 120, 0, 0];
            for (var i = nbPlayers - 1; i >= 0; i--) {
                setTimeout(function() {
                    index ++;
                    var color =  index % 2 == 1 ? "red" : "blue";
                    var player = new Player(null, null, color);

                    player.index = players[color].length
                    players[color].push(player);
                    teams[color].addPlayer(player);
                    player.container.css({'left':  (offset[nbPlayers] + 270 * player.index) +'px'})
                }, i*200);
            };

            // setTimeout(function() {
            //     (function defineInfo(id){
            //         setTimeout(function() {
            //             players["red"][id].realPlayer(champions[id], null, {name: 'Vivacious Jon', division:'Diamond 1', winrate: 80, games: 420});
            //             players["red"][id].definePercent(100);
            //             players["blue"][id].realPlayer(champions[id], null, {name: 'Vivacious Jon', division:'Diamond 1', winrate: 80, games: 420});
            //             players["blue"][id].definePercent(100);
            //             id ++;
            //             if (id < 5) {
            //                 defineInfo(id);
            //             }
            //         }, 100)
            //     })(0);
            // }, 2500);
            function checkEmpty(obj) {
                for (var key in obj) {
                    if (hasOwnProperty.call(obj, key)) return false;
                }
                return true;
            }
            setTimeout(function() {
                var indexP = {red: 0, blue: 0};
                for (var i = data.participants.length - 1; i >= 0; i--) {
                    var participant = data.participants[i];
                    var color = participant.teamId == 100 ? "blue" : "red";
                    console.log( participant);
                    console.log( !checkEmpty(participant.infos) );
                    var infos =  {
                        name: participant.summonerName,
                        division:  !checkEmpty(participant.infos) ? participant.infos.tier.toLowerCase() +'_'+ participant.infos.entries[0].division.toLowerCase() : '',
                        winrate:   !checkEmpty(participant.infos) ? parseInt(100 * ((participant.infos.entries[0].wins) / (participant.infos.entries[0].losses + participant.infos.entries[0].wins))): '',
                        games:     !checkEmpty(participant.infos) ? parseInt(participant.infos.entries[0].wins) + parseInt(participant.infos.entries[0].losses): ''
                    }
                    console.log(players);
                    players[color][indexP[color]].realPlayer( participant.championId,
                        null,
                        [ participant.spell1Id, participant.spell2Id ],
                        infos,
                        participant.profileIconId
                    );
                    players[color][indexP[color]].definePercent(100);
                    // getChamps();
                    indexP[color]++;
                }

            }, 2500);
        }
        test(JSON.parse(getSynchronizedVariant("gameInfo")));
    }
var respTest = {"gameId":2098462209,"mapId":11,"gameMode":"CLASSIC","gameType":"MATCHED_GAME","gameQueueConfigId":4,"participants":[
{"teamId":100,"spell1Id":14,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":539,"summonerName":"Sidesprang","bot":false,"summonerId":22338565},
{"teamId":100,"spell1Id":4,"spell2Id":11,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":502,"summonerName":"KingWorsa","bot":false,"summonerId":34857282},
{"teamId":100,"spell1Id":7,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":18,"summonerName":"Enton","bot":false,"summonerId":39484945},
{"teamId":100,"spell1Id":12,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":18,"summonerName":"Bones to Papayas","bot":false,"summonerId":43672112},
{"teamId":100,"spell1Id":7,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":539,"summonerName":"Wild Porygon","bot":false,"summonerId":41527558},
{"teamId":200,"spell1Id":4,"spell2Id":11,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":684,"summonerName":"The Wang Carry","bot":false,"summonerId":24560332},
{"teamId":200,"spell1Id":7,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":518,"summonerName":"Fungar","bot":false,"summonerId":25595670},
{"teamId":200,"spell1Id":14,"spell2Id":4,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":502,"summonerName":"yung baloo","bot":false,"summonerId":22025113},
{"teamId":200,"spell1Id":4,"spell2Id":3,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":544,"summonerName":"Alamolo","bot":false,"summonerId":19402186},
{"teamId":200,"spell1Id":4,"spell2Id":12,"championId":Math.floor(Math.random() * 113) + 1,"profileIconId":563,"summonerName":"DG Basko","bot":false,"summonerId":22385395}]}
    // var champions = ['Nami', 'Draven', 'Forecast_Janna', 'Pulsefire_Ezreal', 'Aatrox']

    init();
    Player.prototype.readyAnimation = function() {
        this.blinkMask.addClass('blink');
    }


    $('body').keydown(function(e) {
        var keyCode = e.keyCode || e.which;
        if (keyCode == 9) {
            e.preventDefault();
            for (var i = players['red'].length - 1; i >= 0; i--) {
                players['red'][i].hiddenInfo.show();
                players['red'][i].footer.hide();
                players['blue'][i].hiddenInfo.show();
                players['blue'][i].footer.hide();
            };
        }
    });
    $('body').keyup(function(e) {
        var keyCode = e.keyCode || e.which;
        if (keyCode == 9) {
            e.preventDefault();
            for (var i = players['red'].length - 1; i >= 0; i--) {
                players['red'][i].hiddenInfo.hide();
                players['red'][i].footer.show();
                players['blue'][i].hiddenInfo.hide();
                players['blue'][i].footer.show();
            };
        }
    });
</script>
    </body>
</html>
